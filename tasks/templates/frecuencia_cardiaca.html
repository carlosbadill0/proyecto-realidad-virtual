{% extends 'base.html' %} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/evaluar.css' %}" />
   
  </head>
  <body>
    <div class="contenedor">
      <div class="container main-container">
        <div class="row mb-4">
          <div class="row">
            <div class="col-lg-8 content-left">
              <div>
                <button onclick="iniciarGuardado()">Iniciar Guardado</button>
                <button onclick="detenerGuardado()">Detener Guardado</button>
              
                <div class="col-md-12 mt-3 section-card">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Contenido en Vivo</h5>
                      <button id="startCapture" class="btn btn-primary">
                        Iniciar Transmisión
                      </button>
                      <video
                        id="liveVideo"
                        width="100%"
                        height="400px"
                        style="border: none"
                        autoplay
                      ></video>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  {% for expositor in expositores %} {% if expositor.id == expositor_seleccionado.id %}
                  <label for="nombre_expositor" class="form-label"
                    >Nombre Expositor</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="nombre_expositor"
                    value="{{ expositor.nombre }}"
                  />
                  {% endif %} {% endfor %}
                </div>
                <div class="mt-3">
                  <form
                    method="POST"
                    action="{% url 'evaluar_expositor' expositor_seleccionado.id evaluacion.id %}"
                  >
                    {% csrf_token %}
                    <label for="tiempo-exposicion" class="form-label"
                      >Tiempo de Exposición</label
                    >
                    <div id="timer" class="form-control"></div>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-4 content-right">
              <div class="info-box">
                <label for="fecha_evaluacion" class="form-label"
                  >Fecha Evaluación</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="fecha_evaluacion"
                  value="2024-08-20"
                />
              </div>
              <div class="info-box">
                {% for evaluacion in evaluaciones %} {% if evaluacion.id == ultima_evaluacion.id %} {% if evaluacion.expositor_id == expositor_seleccionado.id %}
                <label for="nombre_evaluador" class="form-label"
                  >Nombre Evaluador</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="nombre_evaluador"
                  value="{{ evaluacion.nombre_evaluador }}"
                />
                {% endif %} {% endif %} {% endfor %}
              </div>
              <div class="info-box">
                <form
                  id="evaluacionForm"
                  method="POST"
                  action="{% url 'evaluar_expositor' expositor_seleccionado.id evaluacion.id %}"
                >
                  {% csrf_token %}
                  <input
                    type="hidden"
                    name="tiempo_total"
                    id="tiempo_total"
                    value=""
                  />
                  <div class="info-box">
                    <label for="observacionFinal" class="form-label"
                      >Observación Final</label
                    >
                    <textarea
                      id="observacionFinal"
                      class="form-control"
                      name="observacion_final"
                      rows="3"
                      required
                    ></textarea>
                  </div>
                </form>
              </div>
              <div class="info-box">
                <label class="form-label">Evaluación de prueba</label>
                <div class="d-grid gap-2">
                  {% for escenario in escenarios %}
                  <button
                    class="btn {% if escenario.tag_name == 'high' %}btn-danger{% elif escenario.tag_name == 'medium' %}btn-warning{% elif escenario.tag_name == 'low' %}btn-success{% else %}btn-custom2{% endif %}"
                  >
                    {{ escenario.function_name }} - {{ escenario.duration }}
                    segundos
                  </button>
                  {% endfor %}
                </div>
              </div>
              <div class="chart-container text-center" id="frecuencia_cardiaca">
                <label class="form-label">
                  <pre>Frecuencia actual:   <span id="frecuencia"></span></pre>
                </label>
                <canvas id="graficoFrecuencia"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>  
    
    <script>
      const serverUrlPost = "http://localhost:127/api/frecuencia/"; // Cambiar a localhost
      const serverUrlGet = "http://localhost:127/api/ultima_frecuencia/"; // Cambiar a localhost
      const evaluacionId = "{{ evaluacion.id }}";
      console.log(evaluacionId);
      let currentStage = 1;
      let isEvaluating = false;
      let startTime;
      let timerInterval;
      let chart;

      document.addEventListener("DOMContentLoaded", function () {
        // Inicializa en la primera etapa
        showStage(1);

        // Configura los botones de navegación de etapas
        document
          .getElementById("nextStage1")
          .addEventListener("click", function () {
            showStage(2);
          });

        document
          .getElementById("nextStage2")
          .addEventListener("click", function () {
            showStage(3);
          });

        // Configura el botón de evaluación
        document
          .getElementById("evaluationButton")
          .addEventListener("click", function (event) {
            event.preventDefault();
            const button = this;
            if (!isEvaluating) {
              // Iniciar evaluación
              button.textContent = "Finalizar evaluación";
              isEvaluating = true;
              startTime = new Date();
              timerInterval = setInterval(updateTimer, 1000);
            } else {
              // Finalizar evaluación
              button.textContent = "Iniciar evaluación";
              isEvaluating = false;
              clearInterval(timerInterval);

              // Calcular tiempo total
              const now = new Date();
              const elapsedTime = Math.floor((now - startTime) / 1000);
              document.getElementById("tiempo_total").value = elapsedTime;

              // Enviar el formulario
              document.getElementById("evaluacionForm").submit();
            }
          });

        // Inicializa el gráfico
        const ctx = document
          .getElementById("graficoFrecuencia")
          .getContext("2d");
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [], // Etiquetas de tiempo
            datasets: [
              {
                label: "Frecuencia Cardíaca (BPM)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                data: [], // Datos de frecuencia
                fill: false,
              },
            ],
          },
          options: {
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "second",
                },
                title: {
                  display: true,
                  text: "Tiempo",
                },
              },
              y: {
                beginAtZero: true,
                suggestedMax: 150,
                title: {
                  display: true,
                  text: "BPM",
                },
              },
            },
          },
        });

        // Obtener y enviar datos de evaluación
        const bpm = document.getElementById("bpm-value").textContent;
        enviarDatosAlServidor(bpm, evaluacionId);

        // Obtener la última frecuencia inicialmente y luego cada 3 segundos
        obtenerFrecuencia();
        setInterval(obtenerFrecuencia, 1000);
      });

      function showStage(stage) {
        document
          .querySelectorAll(".stage-container")
          .forEach(function (container) {
            container.style.display = "none";
          });
        document.getElementById("stage-" + stage).style.display = "block";
        currentStage = stage;
      }

      function updateTimer() {
        const now = new Date();
        const elapsedTime = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60);
        const seconds = elapsedTime % 60;
        document.getElementById(
          "timer"
        ).textContent = `${minutes}m ${seconds}s`;
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      function iniciarGuardado() {
        axios
          .post("/api/iniciar_guardado/")
          .then((response) => {
            console.log("Guardado iniciado:", response.data);
          })
          .catch((error) => {
            console.error("Error al iniciar guardado:", error);
          });
      }

      function detenerGuardado() {
        axios
          .post("/api/detener_guardado/")
          .then((response) => {
            console.log("Guardado detenido:", response.data);
          })
          .catch((error) => {
            console.error("Error al detener guardado:", error);
          });
      }

      function enviarDatosAlServidor(bpm, evaluationId) {
        axios
          .post("/api/frecuencia/", {
            bpm: parseInt(bpm),
            evaluationId: parseInt(evaluationId),
          })
          .then((response) => {
            console.log("Datos enviados correctamente:", response.data);
          })
          .catch((error) => {
            console.error("Error al enviar datos:", error);
            if (error.response) {
              console.error("Detalles del error:", error.response);
            } else if (error.request) {
              console.error(
                "No se recibió respuesta del servidor:",
                error.request
              );
            } else {
              console.error("Error al configurar la solicitud:", error.message);
            }
          });
      }

      function obtenerFrecuencia() {
        axios
          .get(serverUrlGet)
          .then((response) => {
            console.log("Frecuencia obtenida:", response.data);
            if (response.data.status === "success") {
              const frecuencia = response.data.frecuencia;
              const now = new Date();
              chart.data.labels.push(now);
              chart.data.datasets[0].data.push(frecuencia);
              chart.update();
              document.getElementById("frecuencia").textContent = frecuencia;
            }
          })
          .catch((error) => {
            console.error("Error al obtener frecuencia:", error);
            if (error.response) {
              console.error("Detalles del error:", error.response);
            } else if (error.request) {
              console.error(
                "No se recibió respuesta del servidor:",
                error.request
              );
            } else {
              console.error("Error al configurar la solicitud:", error.message);
            }
          });
      }

      // Ejemplo de cómo podrías llamar a esta función
      document.addEventListener("DOMContentLoaded", function () {
        const bpmElement = document.getElementById("bpm-value");
        if (bpmElement) {
          const frecuencia = bpmElement.textContent;
          enviarDatosAlServidor(frecuencia);
        }
      });

      document
        .getElementById("startCapture")
        .addEventListener("click", async function () {
          try {
            const stream = await navigator.mediaDevices.getDisplayMedia({
              video: true,
            });
            const videoElement = document.getElementById("liveVideo");
            videoElement.srcObject = stream;
          } catch (err) {
            console.error("Error: " + err);
          }
        });
    </script>
  </body>
</html>

{% endblock %}
